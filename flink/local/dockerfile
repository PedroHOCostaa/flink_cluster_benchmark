# A imagem base está correta.
FROM flink:1.19.1-java11

USER root

# Instala as dependências e o JDK completo.
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        openjdk-11-jdk-headless \
        build-essential \
        python3-dev && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Atualiza a variável JAVA_HOME para o JDK instalado via apt.
ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-arm64

# Instala o PyFlink
RUN pip3 install apache-flink==1.19.1

# --- CORREÇÃO DE PERMISSÃO DO CONECTOR KAFKA ---
# Adiciona o conector e já define o usuário 'flink' como dono do arquivo.
# Isso resolve o problema de permissão de forma mais direta.
ADD --chown=flink:flink https://repo1.maven.org/maven2/org/apache/flink/flink-connector-kafka/3.2.0-1.19/flink-connector-kafka-3.2.0-1.19.jar /opt/flink/lib/

# Define os executáveis Python para o cliente e para os workers.
ENV PYFLINK_PYTHON=/usr/bin/python3
ENV PYFLINK_CLIENT_EXECUTABLE=/usr/bin/python3

# Volta para o usuário padrão do Flink.
USER flink

